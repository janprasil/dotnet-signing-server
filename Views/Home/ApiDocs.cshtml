@{
  ViewData["Title"] = "API Documentation";
}

<h1>API Documentation</h1>
<p class="muted">
  All endpoints live under <code>/api</code> and expect JSON. PDFs, certificates, and attachments are base64 strings.
  Add <code>Authorization: Bearer &lt;token&gt;</code> (create tokens in <a href="/ApiTokens">API Tokens</a>).
  Non-2xx responses include a <code>message</code>.
</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:1rem 0;">
  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:0.75rem;">
    <strong>Credits</strong>
    <p class="muted" style="margin:6px 0 0;">Presign is free. Sign/attachment/timestamp/sign-pfx cost 1 credit.
      Find-codes and fill-pdf cost 1 credit per started 3 pages (9 pages → 3 credits).</p>
  </div>
  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:0.75rem;">
    <strong>Limits</strong>
    <p class="muted" style="margin:6px 0 0;">PDFs & templates: 20MB. Images: 1MB. Attachments: 10MB. Request body limit:
      40MB. Too-large requests return “Request exceeded limit”.</p>
  </div>
  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:0.75rem;">
    <strong>Abuse protection</strong>
    <p class="muted" style="margin:6px 0 0;">Concurrent API calls per user/IP are throttled; bursts return HTTP 429.</p>
  </div>
</div>

<h2>Endpoint overview</h2>
<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Path</th>
      <th>Purpose</th>
      <th>Credits</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>POST</td>
      <td><code>/api/presign</code></td>
      <td>Prepare PDF and return hash to sign</td>
      <td>0</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/sign</code></td>
      <td>Finalize presigned PDF</td>
      <td>1</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/sign-pfx</code></td>
      <td>Sign directly with PFX</td>
      <td>1</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/timestamp</code></td>
      <td>Apply TSA timestamp</td>
      <td>1</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/attachment</code></td>
      <td>Embed attachment</td>
      <td>1</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/fill-pdf</code></td>
      <td>Fill a template with data</td>
      <td>1 credit / 3 pages / output</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/find-codes</code></td>
      <td>Scan for QR/DataMatrix/PDF417/Aztec</td>
      <td>1 credit / 3 pages</td>
    </tr>
    <tr>
      <td>POST</td>
      <td><code>/api/pdf-template</code></td>
      <td>Create template</td>
      <td>0</td>
    </tr>
    <tr>
      <td>GET</td>
      <td><code>/api/pdf-template</code></td>
      <td>List templates</td>
      <td>0</td>
    </tr>
    <tr>
      <td>GET</td>
      <td><code>/api/pdf-template/{id}</code></td>
      <td>Get template</td>
      <td>0</td>
    </tr>
    <tr>
      <td>PUT</td>
      <td><code>/api/pdf-template/{id}</code></td>
      <td>Update template</td>
      <td>0</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td><code>/api/pdf-template/{id}</code></td>
      <td>Delete template</td>
      <td>0</td>
    </tr>
    @* <tr>
      <td>POST</td>
      <td><code>/api/ai/detect-fields</code></td>
      <td>Auto-detect fields (when AI is configured)</td>
      <td>0</td>
    </tr> *@
  </tbody>
</table>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Presign</h3>
  <pre><code>POST /api/presign
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "certificatePem": "-----BEGIN CERTIFICATE-----…",
  "pdfContent": "base64-pdf",
  "location": "Prague, CZ",
  "reason": "Approving contract",
  "signRect": { "x": 50, "y": 120, "width": 200, "height": 50 },
  "signPageNumber": 1,
  "signImageContent": "base64-png-optional",
  "fieldName": "Signature1",
  "tsaUrl": "https://freetsa.org/tsr"
}

Response:
{ "id": "ef2c4d7a-…", "hashToSign": "6c3d…9f" }</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Finalize signing</h3>
  <pre><code>POST /api/sign
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{ "id": "ef2c4d7a-…", "signedHash": "base64-signature" }

Response:
{ "result": "base64-pdf-with-signature" }</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Sign with PFX</h3>
  <pre><code>POST /api/sign-pfx
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "pdfContent": "base64-pdf",
  "pfxContent": "base64-pfx",
  "pfxPassword": "password",
  "location": "Prague, CZ",
  "reason": "Internal approval",
  "signRect": { "x": 40, "y": 100, "width": 180, "height": 45 },
  "signPageNumber": 1,
  "signImageContent": null,
  "fieldName": "Signature1"
}

Response:
{ "result": "base64-pdf-with-signature" }</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Apply timestamp</h3>
  <pre><code>POST /api/timestamp
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "pdfContent": "base64-pdf",
  "location": "Prague, CZ",
  "reason": "Timestamp",
  "signRect": { "x": 30, "y": 90, "width": 180, "height": 40 },
  "signPageNumber": 1,
  "fieldName": "Timestamp1",
  "tsaUrl": "https://freetsa.org/tsr"
}

Response:
{ "result": "base64-pdf-with-timestamp" }</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Add attachment</h3>
  <pre><code>POST /api/attachment
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "pdfContent": "base64-pdf",
  "attachmentContent": "base64-binary",
  "fileName": "terms.pdf",
  "description": "Terms and conditions",
  "mimeType": "application/pdf"
}

Response:
{ "result": "base64-pdf-with-attachment" }</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Fill PDF from template</h3>
  <p class="muted" style="margin:0 0 6px;">Costs 1 credit per started 3 pages per generated output (dataset).</p>
  <pre><code>POST /api/fill-pdf
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "templateId": "a1b2c3d4-…",
  "data": [
    { "data": [ { "fieldName": "Name", "value": "Ada" } ] },
    { "data": [ { "fieldName": "Name", "value": "Grace" } ] }
  ]
}

Response:
{ "files": ["base64-pdf", "base64-pdf"], "templateId": "a1b2c3d4-…" }</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Find barcodes</h3>
  <p class="muted" style="margin:0 0 6px;">Costs 1 credit per started 3 pages.</p>
  <pre><code>POST /api/find-codes
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "pdfContent": "base64-pdf",
  "codeType": "any" // qr | datamatrix | pdf417 | aztec | any
}

Response:
{
  "results": [
    { "value": "INV-2024-001", "codeType": "QR_CODE", "position": { "x": 212.5, "y": 412.0 }, "page": 2 }
  ]
}</code></pre>
</div>

<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
  <h3 style="margin-top:0;">Manage templates</h3>
  <pre><code>// Create
POST /api/pdf-template
{
  "pdfContent": "base64-pdf",
  "templateName": "Invoice",
  "fields": [
    { "fieldName": "Name", "page": 1, "rect": { "x": 40, "y": 700, "width": 200, "height": 32 }, "type": "text" }
  ]
}

// List
GET /api/pdf-template
// Get
GET /api/pdf-template/{templateId}
// Update
PUT /api/pdf-template/{templateId}
// Delete
DELETE /api/pdf-template/{templateId}</code></pre>
</div>

@* <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;margin-top:1.25rem;">
<h3 style="margin-top:0;">AI: Detect fields (optional)</h3>
<p class="muted" style="margin:0 0 6px;">Available when AI is configured in environment variables. Returns inferred fields for Template Builder.</p>
<pre><code>POST /api/ai/detect-fields
{
  "pdfContent": "base64-pdf",
  "prompt": "Detect fields for an invoice."
}

Response:
{
  "fields": [
    { "fieldName": "Total", "page": 1, "rect": { "x": 420, "y": 110, "width": 120, "height": 28 }, "type": "text" }
  ]
}</code></pre>
</div> *@

<p class="muted" style="margin-top:1.5rem;">
  Need help? Reach out with the endpoint path, timestamp, and request ID from your logs.
</p>
