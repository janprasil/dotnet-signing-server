version: "3.8"

services:
  # The .NET Signing Server Service
  server:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    volumes:
      - data_protection_keys:/app/data-protection-keys
    # ports:
    #   - "80:8085"
    environment:
      - ASPNETCORE_URLS=http://+:8085
      - AllowedHosts=${ALLOWED_HOSTS:-*}
      - UseLocalDb=false
      - ConnectionStrings__DefaultConnection=Host=${DB_HOST};Port=${DB_PORT};Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}
      - TSA_URL=${TSA_URL:-}
      - TSA_USERNAME=${TSA_USERNAME:-}
      - TSA_PASSWORD=${TSA_PASSWORD:-}
      # Stripe configuration
      - Stripe__ApiKey=${STRIPE_API_KEY:-}
      - Stripe__WebhookSecret=${STRIPE_WEBHOOK_SECRET:-}
      - Stripe__Currency=${STRIPE_CURRENCY:-EUR}
      - Stripe__EnableTaxIdCollection=${STRIPE_ENABLE_TAX_ID_COLLECTION:-true}
      - Stripe__RequireBillingAddress=${STRIPE_REQUIRE_BILLING_ADDRESS:-true}
      - Stripe__EnableAutomaticTax=${STRIPE_ENABLE_AUTOMATIC_TAX:-true}
      # SMTP configuration
      - Smtp__Host=${SMTP_HOST:-smtp.example.com}
      - Smtp__Port=${SMTP_PORT:-587}
      - Smtp__UseSsl=${SMTP_USE_SSL:-true}
      - Smtp__FromAddress=${SMTP_FROM_ADDRESS:-no-reply@example.com}
      - Smtp__FromName=${SMTP_FROM_NAME:-DotNet Signing Server}
      - Smtp__Username=${SMTP_USERNAME:-}
      - Smtp__Password=${SMTP_PASSWORD:-}
      # Loki logging
      - Loki__Url=${LOKI_URL:-}
      - Loki__Username=${LOKI_USERNAME:-}
      - Loki__Password=${LOKI_PASSWORD:-}
      - Loki__BearerToken=${LOKI_BEARER_TOKEN:-}
      - Loki__App=${LOKI_APP:-dotnet-signing-server}
      - Loki__Environment=${LOKI_ENVIRONMENT:-development}
      # AI (Google)
      - AI__Enabled=${AI_ENABLED:-false}
      - AI__Provider=${AI_PROVIDER:-google}
      - AI__Google__ApiKey=${AI_GOOGLE_API_KEY:-}
      - AI__Google__Model=${AI_GOOGLE_MODEL:-gemini-1.5-flash}
      - AI__Google__Endpoint=${AI_GOOGLE_ENDPOINT:-https://generativelanguage.googleapis.com/v1beta}
      # Size limits
      - Limits__PdfMaxBytes=${PDF_MAX_BYTES:-20971520}
      - Limits__ImageMaxBytes=${IMAGE_MAX_BYTES:-1048576}
      - Limits__AttachmentMaxBytes=${ATTACHMENT_MAX_BYTES:-10485760}
      - Limits__RequestBodyLimitBytes=${REQUEST_BODY_LIMIT_BYTES:-41943040}
      - Limits__MaxConcurrentRequestsPerKey=${MAX_CONCURRENT_REQUESTS_PER_KEY:-25}
      - DATA_PROTECTION_KEYS_PATH=/app/data-protection-keys
    labels:
      - "caddy_0.handle=/*"
      - "caddy_0.handle.0_reverse_proxy={{upstreams 8085}}"
      - "caddy_0.handle.0_reverse_proxy.header_up_1=X-Forwarded-Proto https"
      - "caddy_0.handle.0_reverse_proxy.header_up_0=X-Forwarded-For {remote_host}"
      - "caddy_0.handle.0_reverse_proxy.header_up_2=X-Forwarded-Host {host}"

volumes:
  data_protection_keys:
